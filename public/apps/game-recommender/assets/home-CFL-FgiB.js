import{a as l,p as e,z as C,w as T}from"./chunk-OIYGIGL5-D4m_JISv.js";import{s as N,g as E,A as w}from"./gameapi.service-Bv2HBavA.js";import{T as R,c as L}from"./RateLimiter-swVSsLao.js";import{S,s as $}from"./searchStateContext-mAK-N42P.js";import{m as j}from"./proxy-BTL25mS4.js";function k({searchString:t,selectedTags:m,addTag:s,onTagAdded:h}){const d=l.useContext(N),[o,u]=l.useState([]),[r,a]=l.useState(0);l.useEffect(()=>{const c=i();u(c)},[t,d,m]),l.useEffect(()=>{function c(n){const f=document.activeElement,v=document.getElementById("add-tag-input");f===v&&(n.key==="Enter"&&o.length>0?(n.preventDefault(),s(o[r]),h(),a(0)):n.key==="ArrowDown"?a(x=>x<o.length-1?x+=1:x):n.key==="ArrowUp"&&a(x=>x>0?x-=1:x))}return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[o,s,h,r]);function i(){if(!d||!t||t.length<3)return[];const c=[],n=t.toLowerCase();return d?.genreTags&&c.push(...d.genreTags.filter(f=>f.name.toLowerCase().includes(n))),d?.platformTags&&c.push(...d.platformTags.filter(f=>f.name.toLowerCase().includes(n)||f.alternative_name?.toLowerCase().includes(n)||f.abbreviation?.toLowerCase().includes(n))),d?.keywordTags&&c.push(...d.keywordTags.filter(f=>f.name.toLowerCase().includes(n))),c}return!d||!t||t.length<3?e.jsx(e.Fragment,{}):e.jsx("div",{className:"tag-finder",style:{position:"absolute",zIndex:25,left:0,right:0,maxHeight:"30rem",display:"inline",width:"100%",height:"max-content"},"data-testid":"search-tag-finder",children:o.map((c,n)=>e.jsxs("div",{className:n===r?"tag-result-selected":"tag-result",onClick:()=>{s(c)},role:"button","aria-label":"search tag button","data-testid":n===r?"tag-result-selected":"tag-result",children:[e.jsx("p",{children:c.formattedType}),e.jsx("p",{children:c.name})]},`${c.type}-${c.id}`))})}function F({restoredTags:t=[],onSearch:m}){const[s,h]=l.useState([]),[d,o]=l.useState("");l.useEffect(()=>{!t||t.length===0||h(t)},[t]);function u(i){h(c=>[...c,i]),o("")}function r(i){i.preventDefault(),m(s,0)}function a(i){h(c=>c.filter(n=>n!==i))}return e.jsx("div",{className:"search-bar","data-testid":"search-bar",children:e.jsx("form",{onSubmit:r,children:e.jsxs("div",{className:"input-container",children:[e.jsxs("div",{className:"text-input",style:{position:"relative"},children:[e.jsx("input",{type:"text",id:"add-tag-input",value:d,onChange:i=>o(i.target.value),placeholder:"Â ","data-testid":"add-tag-input",role:"searchbox"}),e.jsx("label",{htmlFor:"add-tag-input",className:"text-input-label",children:"Add tag"}),e.jsx("span",{className:"focus-bg"}),e.jsx("div",{className:"search-result-holder",style:{position:"relative"},children:e.jsx(k,{addTag:u,searchString:d,selectedTags:s,onTagAdded:()=>o("")})})]}),e.jsxs("div",{className:"tags-display",children:[e.jsx("p",{children:"Included Tags"}),e.jsx("div",{className:"tags-container",children:s.map(i=>e.jsx(R,{id:`tag-pill-${i.id}`,handleClick:()=>a(i),ariaLabel:`Selected Tag to search with, 
                                    click to remove from search criteria`,text:`${i.formattedType}: ${i.name}`,canDelete:!0},`tag-pill-${i.id}`))})]}),e.jsx("button",{className:"button-text",type:"submit",disabled:s.length===0,role:"button",children:"Search Games"})]})})})}function U({text:t,maxLines:m=0,className:s="body-text"}){const h=l.useRef(null),[d,o]=l.useState(t),[u,r]=l.useState(!1);return l.useEffect(()=>{if(!h.current)return;const a=h.current,c=parseFloat(getComputedStyle(a).lineHeight)*m;if(a.scrollHeight>c){r(!0);let n=0,f=t.length,v=t;for(;n<=f;){const x=Math.floor((n+f)/2),p=t.slice(0,x)+"...";a.textContent=p,a.scrollHeight<=c?(v=p,n=x+1):f=x-1}o(v)}else r(!1),o(t)},[t,m]),e.jsx("p",{ref:h,className:s,title:u?t:void 0,children:d})}function _({gameInfo:t}){const m=l.useContext(N),s=l.useRef(null),[h,d]=l.useState(null),[o,u]=l.useState(!1),[r,a]=l.useState(""),[i,c]=l.useState(!1),n=l.useRef(!1);l.useEffect(()=>{if(!s.current)return;const p=new IntersectionObserver(g=>{g.forEach(y=>{y.isIntersecting&&(c(!0),p.disconnect())})},{rootMargin:"100px",threshold:.1});return p.observe(s.current),()=>{p.disconnect()}},[]),l.useEffect(()=>{if(!i||n.current)return;async function p(){try{u(!0);const g=await L.add(async()=>await E.getCover(t.id));if(!g.success){d("Failed to load cover image!");return}a(g.imageUrl)}catch(g){console.error("Error when trying to get cover image: ",g),d("Failed to load cover image!")}finally{u(!1)}}p()},[i,t.id]);function f(p){const g=m?.platformTags.find(y=>y.id===p);return g?g.name:"Not found"}function v(){const g=234*1.3333333333333333;return i?o?e.jsx(j.div,{className:"game-cover-loading",style:{width:"100%",height:`${g}px`,borderRadius:"4px"},initial:{opacity:.4},animate:{opacity:1},transition:{duration:.5,ease:"linear",repeat:1/0,repeatType:"reverse"}},`game-cover-loading-${t.id}`):h?e.jsx("div",{className:"game-cover-loading-error",style:{width:"100%",height:`${g}px`,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"4px"},children:e.jsx("p",{style:{fontSize:"0.8rem",color:"#666"},children:"No cover available"})}):!r||r===""?e.jsx("div",{className:"game-cover-loading-error",style:{width:"100%",height:`${g}px`,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"4px"},children:e.jsx("p",{style:{color:"white"},children:"No cover URL!"})}):e.jsx(j.img,{src:r,alt:`${t.name} cover`,loading:"lazy",initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},onError:()=>{console.error(`Failed to load image: ${r}`),d("Image load failed")}}):e.jsx("div",{className:"game-cover-placeholder",style:{width:"100%",height:`${g}px`,backgroundColor:"#2a2a2a",borderRadius:"4px"}})}function x(){const p=S.getSearchPathFromLocation(location.pathname);return S.buildDetailUrl(t.id,p)}return e.jsxs("div",{className:"card game-card",ref:s,"data-testid":"game-card",children:[e.jsx("div",{className:"game-card-cover-container",children:v()}),e.jsxs("div",{className:"game-card-info-container",children:[e.jsx(C,{className:"game-card-title",to:`/${x()}`,children:t.name}),e.jsx(U,{text:t.summary===""?"No description.":t.summary,maxLines:11,className:"game-card-description"})]}),e.jsxs("div",{className:"game-card-stats",children:[e.jsxs("div",{className:"game-card-year-label",children:[e.jsx("p",{className:"body-text",children:"Year: "}),e.jsx("p",{className:"body-text-bold",children:t.first_release_date_formatted?.toLocaleDateString("en-GB")})]}),e.jsxs("div",{className:"game-card-platforms",children:[e.jsx("p",{className:"body-text",children:"Platforms: "}),e.jsx("div",{className:"game-card-platforms-container",children:t.platforms?.map(p=>e.jsx("div",{className:"platform-pill",children:e.jsx("p",{children:f(p)})},`platform-pill-${p}`))})]})]})]},`game-card-${t.id}`)}function b({currentPage:t,totalPages:m,onPageChange:s}){function h(o){return o===t?"page-button-number-selected":"page-button-number"}function d(){const o=[];if(o.push(e.jsx("button",{className:"page-button-prev",onClick:()=>s(t-1),disabled:t===1,children:"Prev"},"page-button-prev")),m<=4)for(let u=1;u<=m;u++)o.push(e.jsx("button",{className:h(u),onClick:()=>s(u),children:u},`page-button-${u}`));else{let u=1,r=3;t>=3&&t<m&&(u=t-1,r=t+1);for(let a=u;a<=r;a++)o.push(e.jsx("button",{className:h(a),onClick:()=>s(a),children:a},`page-button-${a}`));o.push(e.jsx("div",{className:"page-button-divider",children:e.jsx("p",{className:"body-text",children:"..."})},"page-button-divider")),o.push(e.jsx("button",{className:h(m),onClick:()=>s(m),children:m},`page-button-${m}`))}return o.push(e.jsx("button",{className:"page-button-next",onClick:()=>s(t+1),disabled:t===m,children:"Next"},"page-button-next")),o}return e.jsx("div",{className:"page-button-container",children:d()})}function A({results:t,isLoading:m,searchTags:s,currentOffset:h,onSearch:d}){const u=Math.floor(h/50)+1,r=Math.ceil(t.count/50),a={count:t.count,offset:h,displayEnd:h+Math.min(50,t.count-h)};function i(){const n=[];for(let f=0;f<5;f++)n.push(e.jsx(j.div,{role:"loading-placeholder-card",className:"card loading-card",initial:{opacity:.3},animate:{opacity:1},transition:{duration:1.5,repeat:1/0,ease:"linear"}},`loading-card-${f}`));return n}function c(n){n<1||n>r||d(s,(n-1)*50)}return s.length===0?e.jsx("div",{id:"not-yet-searched",children:"Try searching!"}):m?e.jsxs("div",{className:"search-results",children:[e.jsx("h2",{children:"Recommended games"}),e.jsxs("div",{className:"page-info-container",children:[r>1&&e.jsx(b,{currentPage:u,totalPages:r,onPageChange:c}),a.count>0&&e.jsxs("div",{className:"page-info",children:[e.jsxs("p",{className:"body-text",children:["Found ",a.count," games"]}),e.jsxs("p",{className:"body-text",children:["Displaying ",a.offset," -"," ",a.displayEnd]})]})]}),e.jsx("div",{className:"results-grid",children:e.jsx("div",{className:"search-results",children:i()})})]}):t.count===0?e.jsx("div",{children:e.jsx("p",{children:"No Games found matching your tags"})}):e.jsxs("div",{className:"search-results","data-testid":"search-results",children:[e.jsx("h2",{children:"Recommended games"}),e.jsxs("div",{className:"page-info-container",children:[r>1&&e.jsx(b,{currentPage:u,totalPages:r,onPageChange:c}),e.jsxs("div",{className:"page-info",children:[e.jsxs("p",{className:"body-text",children:["Found ",a.count," games"]}),e.jsxs("p",{className:"body-text",children:["Displaying ",a.offset," - ",a.displayEnd]})]})]}),e.jsx("div",{className:"results-grid",children:t.games.map(n=>e.jsx(_,{gameInfo:n},n.id))}),r>1&&e.jsx("div",{className:"page-info-container",children:e.jsx(b,{currentPage:u,totalPages:r,onPageChange:c})})]})}function B(){return[{title:"Game Recommender"},{name:"description",content:"Simple webapp for getting game recommendations"}]}const M=T(function(){const m=l.useContext(N),s=l.useContext($),[h,d]=l.useState({count:0,games:[],offset:0}),[o,u]=l.useState(!1);if(!m)return e.jsx("div",{className:"error-message",children:"Failed to load game data. Please refresh the page."});if(!s)return null;l.useEffect(()=>{if(s.searchTags.length===0){d({count:0,games:[],offset:0});return}if(s===null)return;async function a(){u(!0);try{if(s===null)return;const i=await E.getRecommendations(s.searchTags,s.currentOffset);d(i)}catch(i){console.error("Search failed: ",i)}finally{u(!1)}}a()},[s]);async function r(a,i=0){if(s){if(a.length===0){s.setSearchTags([]),s.setCurrentOffset(0);return}s.setSearchTags(a),s.setCurrentOffset(i)}}return e.jsx(w,{mode:"wait",children:e.jsxs(j.div,{className:"home-page",initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},"data-testid":"home-page",children:[e.jsx(F,{restoredTags:s.searchTags,onSearch:r}),e.jsx(A,{isLoading:o,results:h,searchTags:s.searchTags,onSearch:r,currentOffset:s.currentOffset})]})})});export{M as default,B as meta};
