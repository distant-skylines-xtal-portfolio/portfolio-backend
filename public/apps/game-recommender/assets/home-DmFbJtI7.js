import{a as i,p as e,z as C,w as T}from"./chunk-OIYGIGL5-D4m_JISv.js";import{s as E,g as R,A as $}from"./gameapi.service-Dm-zwIsS.js";import{T as L,c as k}from"./RateLimiter-swVSsLao.js";import{S as w,s as F}from"./searchStateContext-mAK-N42P.js";import{m as j}from"./proxy-BTL25mS4.js";function A({searchString:t,selectedTags:p,addTag:n,onTagAdded:h}){const u=i.useContext(E),[l,m]=i.useState([]),[o,r]=i.useState(0),[c,x]=i.useState(!0),f=i.useRef(null),b=i.useRef(null);i.useEffect(()=>{const d=y();m(d),r(0)},[t,u,p]),i.useEffect(()=>{function d(a){const g=document.getElementById("add-tag-input"),v=a.target;if(!g){console.log("input is null");return}console.log(`handleClickOutside: ${v.nodeName}, inputcontainstarget: ${g.contains(v)}`),f.current&&!f.current.contains(v)&&g&&!g.contains(v)&&x(!1)}function s(a){const g=document.getElementById("add-tag-input");a.target===g&&x(!0)}return document.addEventListener("mousedown",d),document.addEventListener("focusin",s),()=>{document.removeEventListener("mousedown",d),document.removeEventListener("focusin",s)}},[]),i.useEffect(()=>{if(!b.current&&!f.current)return;const d=f.current,s=b.current;if(!d||!s)return;const a=d?.getBoundingClientRect(),g=s?.getBoundingClientRect(),v=g.top<a.top,S=g.bottom>a.bottom;console.log(`isAboveView: ${v}, isBelow: ${S}, itemRect.top: ${g.top}, itemRect.bottom: ${g.bottom}, containerRect.top: ${a.top}, containerRect.bottom: ${a.bottom}`),v?s.scrollIntoView({block:"start",behavior:"smooth"}):S&&s.scrollIntoView({block:"end",behavior:"smooth"})},[o]),i.useEffect(()=>{function d(s){const a=document.activeElement,g=document.getElementById("add-tag-input");a===g&&((s.key==="Enter"||s.key==="ArrowDown"||s.key==="ArrowUp")&&s.preventDefault(),s.key==="Enter"&&l.length>0?(n(l[o]),h(),r(0)):s.key==="ArrowDown"?r(v=>v<l.length-1?v+=1:v):s.key==="ArrowUp"?r(v=>v>0?v-=1:v):s.key==="Escape"&&(x(!1),g?.blur()))}return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[l,n,h,o]);function y(){if(!u||!t||t.length<3)return[];const d=[],s=t.toLowerCase();return u?.genreTags&&d.push(...u.genreTags.filter(a=>a.name.toLowerCase().includes(s))),u?.platformTags&&d.push(...u.platformTags.filter(a=>a.name.toLowerCase().includes(s)||a.alternative_name?.toLowerCase().includes(s)||a.abbreviation?.toLowerCase().includes(s))),u?.keywordTags&&d.push(...u.keywordTags.filter(a=>a.name.toLowerCase().includes(s))),d}return!c||!u||!t||t.length<3?e.jsx(e.Fragment,{}):e.jsx("div",{ref:f,className:"tag-finder",style:{position:"absolute",zIndex:25,left:0,right:0,maxHeight:"30rem",display:"inline",width:"100%",height:"max-content"},"data-testid":"search-tag-finder",children:l.map((d,s)=>{const a=s===o;return e.jsxs("div",{ref:a?b:null,className:a?"tag-result-selected":"tag-result",onClick:()=>{n(d)},role:"button","aria-label":"search tag button","data-testid":a?"tag-result-selected":"tag-result",children:[e.jsx("p",{children:d.formattedType}),e.jsx("p",{children:d.name})]},`${d.type}-${d.id}`)})})}function U({restoredTags:t=[],onSearch:p}){const[n,h]=i.useState([]),[u,l]=i.useState("");i.useEffect(()=>{!t||t.length===0||h(t)},[t]);function m(c){h(x=>[...x,c]),l("")}function o(c){c.preventDefault(),p(n,0)}function r(c){h(x=>x.filter(f=>f!==c))}return e.jsx("div",{className:"search-bar","data-testid":"search-bar",children:e.jsx("form",{onSubmit:o,children:e.jsxs("div",{className:"input-container",children:[e.jsxs("div",{className:"text-input",style:{position:"relative"},children:[e.jsx("input",{type:"text",id:"add-tag-input",value:u,onChange:c=>l(c.target.value),placeholder:"Â ","data-testid":"add-tag-input",role:"searchbox",autoComplete:"off"}),e.jsx("label",{htmlFor:"add-tag-input",className:"text-input-label",children:"Add tag"}),e.jsx("span",{className:"focus-bg"}),e.jsx("div",{className:"search-result-holder",style:{position:"relative"},children:e.jsx(A,{addTag:m,searchString:u,selectedTags:n,onTagAdded:()=>l("")})})]}),e.jsxs("div",{className:"tags-display",children:[e.jsx("p",{children:"Included Tags"}),e.jsx("div",{className:"tags-container",children:n.map(c=>e.jsx(L,{id:`tag-pill-${c.id}`,handleClick:()=>r(c),ariaLabel:`Selected Tag to search with, 
                                    click to remove from search criteria`,text:`${c.formattedType}: ${c.name}`,canDelete:!0},`tag-pill-${c.id}`))})]}),e.jsx("button",{className:"button-text",type:"submit",disabled:n.length===0,role:"button",children:"Search Games"})]})})})}function _({text:t,maxLines:p=0,className:n="body-text"}){const h=i.useRef(null),[u,l]=i.useState(t),[m,o]=i.useState(!1);return i.useEffect(()=>{if(!h.current)return;const r=h.current,x=parseFloat(getComputedStyle(r).lineHeight)*p;if(r.scrollHeight>x){o(!0);let f=0,b=t.length,y=t;for(;f<=b;){const d=Math.floor((f+b)/2),s=t.slice(0,d)+"...";r.textContent=s,r.scrollHeight<=x?(y=s,f=d+1):b=d-1}l(y)}else o(!1),l(t)},[t,p]),e.jsx("p",{ref:h,className:n,title:m?t:void 0,children:u})}function I({gameInfo:t}){const p=i.useContext(E),n=i.useRef(null),[h,u]=i.useState(null),[l,m]=i.useState(!1),[o,r]=i.useState(""),[c,x]=i.useState(!1),f=i.useRef(!1);i.useEffect(()=>{if(!n.current)return;const s=new IntersectionObserver(a=>{a.forEach(g=>{g.isIntersecting&&(x(!0),s.disconnect())})},{rootMargin:"100px",threshold:.1});return s.observe(n.current),()=>{s.disconnect()}},[]),i.useEffect(()=>{if(!c||f.current)return;async function s(){try{m(!0);const a=await k.add(async()=>await R.getCover(t.id));if(!a.success){u("Failed to load cover image!");return}r(a.imageUrl)}catch(a){console.error("Error when trying to get cover image: ",a),u("Failed to load cover image!")}finally{m(!1)}}s()},[c,t.id]);function b(s){const a=p?.platformTags.find(g=>g.id===s);return a?a.name:(console.log(`failed to find platformId: ${s}`),"Not found")}function y(){const a=234*1.3333333333333333;return c?l?e.jsx(j.div,{className:"game-cover-loading",style:{width:"100%",height:`${a}px`,borderRadius:"4px"},initial:{opacity:.4},animate:{opacity:1},transition:{duration:.5,ease:"linear",repeat:1/0,repeatType:"reverse"}},`game-cover-loading-${t.id}`):h?e.jsx("div",{className:"game-cover-loading-error",style:{width:"100%",height:`${a}px`,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"4px"},children:e.jsx("p",{style:{fontSize:"0.8rem",color:"#666"},children:"No cover available"})}):!o||o===""?e.jsx("div",{className:"game-cover-loading-error",style:{width:"100%",height:`${a}px`,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"4px"},children:e.jsx("p",{style:{color:"white"},children:"No cover URL!"})}):e.jsx(j.img,{src:o,alt:`${t.name} cover`,loading:"lazy",initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},onError:()=>{console.error(`Failed to load image: ${o}`),u("Image load failed")}}):e.jsx("div",{className:"game-cover-placeholder",style:{width:"100%",height:`${a}px`,backgroundColor:"#2a2a2a",borderRadius:"4px"}})}function d(){const s=w.getSearchPathFromLocation(location.pathname);return w.buildDetailUrl(t.id,s)}return e.jsxs("div",{className:"card game-card",ref:n,"data-testid":"game-card",children:[e.jsx("div",{className:"game-card-cover-container",children:y()}),e.jsxs("div",{className:"game-card-info-container",children:[e.jsx(C,{className:"game-card-title",to:`/${d()}`,children:t.name}),e.jsx(_,{text:t.summary===""?"No description.":t.summary,maxLines:11,className:"game-card-description"})]}),e.jsxs("div",{className:"game-card-stats",children:[e.jsxs("div",{className:"game-card-year-label",children:[e.jsx("p",{className:"body-text",children:"Year: "}),e.jsx("p",{className:"body-text-bold",children:t.first_release_date_formatted?.toLocaleDateString("en-GB")})]}),e.jsxs("div",{className:"game-card-platforms",children:[e.jsx("p",{className:"body-text",children:"Platforms: "}),e.jsx("div",{className:"game-card-platforms-container",children:t.platforms?.map(s=>e.jsx("div",{className:"platform-pill",children:e.jsx("p",{children:b(s)})},`platform-pill-${s}`))})]})]})]},`game-card-${t.id}`)}function N({currentPage:t,totalPages:p,onPageChange:n}){function h(l){return l===t?"page-button-number-selected":"page-button-number"}function u(){const l=[];if(l.push(e.jsx("button",{className:"page-button-prev",onClick:()=>n(t-1),disabled:t===1,children:"Prev"},"page-button-prev")),p<=4)for(let m=1;m<=p;m++)l.push(e.jsx("button",{className:h(m),onClick:()=>n(m),children:m},`page-button-${m}`));else{let m=1,o=3;t>=3&&t<p&&(m=t-1,o=t+1);for(let r=m;r<=o;r++)l.push(e.jsx("button",{className:h(r),onClick:()=>n(r),children:r},`page-button-${r}`));l.push(e.jsx("div",{className:"page-button-divider",children:e.jsx("p",{className:"body-text",children:"..."})},"page-button-divider")),l.push(e.jsx("button",{className:h(p),onClick:()=>n(p),children:p},`page-button-${p}`))}return l.push(e.jsx("button",{className:"page-button-next",onClick:()=>n(t+1),disabled:t===p,children:"Next"},"page-button-next")),l}return e.jsx("div",{className:"page-button-container",children:u()})}function D({results:t,isLoading:p,searchTags:n,currentOffset:h,onSearch:u}){const m=Math.floor(h/50)+1,o=Math.ceil(t.count/50),r={count:t.count,offset:h,displayEnd:h+Math.min(50,t.count-h)};function c(){const f=[];for(let b=0;b<5;b++)f.push(e.jsx(j.div,{role:"loading-placeholder-card",className:"card loading-card",initial:{opacity:.3},animate:{opacity:1},transition:{duration:1.5,repeat:1/0,ease:"linear"}},`loading-card-${b}`));return f}function x(f){f<1||f>o||u(n,(f-1)*50)}return n.length===0?e.jsx("div",{id:"not-yet-searched",children:"Try searching!"}):p?e.jsxs("div",{className:"search-results",children:[e.jsx("h2",{children:"Recommended games"}),e.jsxs("div",{className:"page-info-container",children:[o>1&&e.jsx(N,{currentPage:m,totalPages:o,onPageChange:x}),r.count>0&&e.jsxs("div",{className:"page-info",children:[e.jsxs("p",{className:"body-text",children:["Found ",r.count," games"]}),e.jsxs("p",{className:"body-text",children:["Displaying ",r.offset," -"," ",r.displayEnd]})]})]}),e.jsx("div",{className:"results-grid",children:e.jsx("div",{className:"search-results",children:c()})})]}):t.count===0?e.jsx("div",{children:e.jsx("p",{children:"No Games found matching your tags"})}):e.jsxs("div",{className:"search-results","data-testid":"search-results",children:[e.jsx("h2",{children:"Recommended games"}),e.jsxs("div",{className:"page-info-container",children:[o>1&&e.jsx(N,{currentPage:m,totalPages:o,onPageChange:x}),e.jsxs("div",{className:"page-info",children:[e.jsxs("p",{className:"body-text",children:["Found ",r.count," games"]}),e.jsxs("p",{className:"body-text",children:["Displaying ",r.offset," - ",r.displayEnd]})]})]}),e.jsx("div",{className:"results-grid",children:t.games.map(f=>e.jsx(I,{gameInfo:f},f.id))}),o>1&&e.jsx("div",{className:"page-info-container",children:e.jsx(N,{currentPage:m,totalPages:o,onPageChange:x})})]})}function M(){return[{title:"Game Recommender"},{name:"description",content:"Simple webapp for getting game recommendations"}]}const O=T(function(){const p=i.useContext(E),n=i.useContext(F),[h,u]=i.useState({count:0,games:[],offset:0}),[l,m]=i.useState(!1);if(!p)return e.jsx("div",{className:"error-message",children:"Failed to load game data. Please refresh the page."});if(!n)return null;i.useEffect(()=>{if(n.searchTags.length===0){u({count:0,games:[],offset:0});return}if(n===null)return;async function r(){m(!0);try{if(n===null)return;const c=await R.getRecommendations(n.searchTags,n.currentOffset);u(c)}catch(c){console.error("Search failed: ",c)}finally{m(!1)}}r()},[n]);async function o(r,c=0){if(n){if(r.length===0){n.setSearchTags([]),n.setCurrentOffset(0);return}n.setSearchTags(r),n.setCurrentOffset(c)}}return e.jsx($,{mode:"wait",children:e.jsxs(j.div,{className:"home-page",initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},"data-testid":"home-page",children:[e.jsx(U,{restoredTags:n.searchTags,onSearch:o}),e.jsx(D,{isLoading:l,results:h,searchTags:n.searchTags,onSearch:o,currentOffset:n.currentOffset})]})})});export{O as default,M as meta};
